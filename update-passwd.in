#!/bin/sh
#
# Merge Fink's passwd and group additions into NetInfo
#

if [ `id -u` -ne 0 ]; then
	echo "You must be root to run update-passwd."
	exit 1
fi

PREFIX=@PREFIX@

merge_user_info() {
	FILE="$1"
	FINK_PASSWD_USER="$2"
	case `uname -r` in
		8*)
				niload passwd . <$FILE
			;;
		*)
			OIFS=$IFS
			IFS=:
			cat $FILE | grep $FINK_PASSWD_USER | while read name passwd uid gid junk1 junk2 junk3 info home shell; do
				dscl . create /users/$name
				dscl . create /users/$name name $name
				dscl . create /users/$name passwd '*'
				dscl . create /users/$name hint ""
				dscl . create /users/$name uid $uid
				dscl . create /users/$name gid $gid
				dscl . create /users/$name home "$home"
				dscl . create /users/$name shell "$shell"
				dscl . create /users/$name realname "$info"
				dscl . delete /users/$name AuthenticationAuthority
			done
			IFS=$OIFS
			;;
	esac
}

merge_group_info() {
	FILE="$1"
	GROUP="$2"
	case `uname -r` in
		8*)
			niload group . <$FILE
			;;
		*)
			OIFS=$IFS
			IFS=:
			cat $FILE | grep $GROUP | while read name passwd gid GroupMembership; do
				dscl . create /groups/$name
				dscl . create /groups/$name name $name
				dscl . create /groups/$name passwd '*'
				dscl . create /groups/$name gid $gid
				dscl . create /groups/$name GroupMembership $GroupMembership
			done
			IFS=$OIFS
			;;
	esac
}

if [ ! $2 ]; then
	echo "No user was specified to be added."
	echo "update-passwd needs to know which user will be added to the system."
	exit 1
fi

if [ ! -f "$PREFIX/etc/passwd-fink" ]; then
	echo "The file $PREFIX/etc/passwd-fink is missing."
	echo "update-passwd can not continue without this file."
	exit 1
fi

if [ ! -f "$PREFIX/etc/group-fink" ]; then
	echo "The file $PREFIX/etc/group-fink is missing."
	echo "update-passwd can not continue without this file."
	exit 1
fi

echo
echo "The following user entry will be added to your NetInfo database:"
grep `echo $2 | /usr/bin/sed "s/^passwd-//"` $PREFIX/etc/passwd-fink

echo
echo "The following group entry will be added to your NetInfo database:"
grep `echo $2 | /usr/bin/sed "s/^passwd-//"` $PREFIX/etc/group-fink

echo
if [ "x$1" = "xpostinst" ]; then
	echo "Existing entries with these names or numbers will be overwritten or"
	echo "otherwise affected by this. On the other hand, some Fink packages will"
	echo "not work unless these entries are in the NetInfo database. You can make"
	echo "adjustments to the files $PREFIX/etc/passwd-fink and"
	echo "$PREFIX/etc/group-fink now (from another window), then say yes here. Or"
	echo "you can say no here and add the users and groups manually (e.g. on your"
	echo "central NetInfo server). If you don't know what all of this is about,"
	echo "just say yes."
else
	echo "Existing entries with these names or numbers will be overwritten or"
	echo "otherwise affected by this."
fi
/bin/echo "Do you want to continue? [Y/n] \c"
read answer

answer=`echo $answer | sed 's/^[yY].*$/y/'`


if [ -z "$answer" -o "x$answer" = "xy" ]; then
	echo
	echo "Merging user info..."
	merge_user_info "$PREFIX/etc/passwd-fink" `echo $2 | /usr/bin/sed "s/^passwd-//"`

	echo "Merging group info..."
	merge_group_info "$PREFIX/etc/group-fink" `echo $2 | /usr/bin/sed "s/^passwd-//"`
	echo "Done."
else
	echo "Okay, not adding the entries."
fi
echo

exit 0
